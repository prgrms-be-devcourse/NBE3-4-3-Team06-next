<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê³„ì¢Œ ê´€ë¦¬</title>
    <link rel="stylesheet" th:href="@{/css/account.css}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="account-container">
    <h2>ê³„ì¢Œ ê´€ë¦¬</h2>

    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <p><strong>ì‚¬ìš©ì ID:</strong> <span id="username" th:text="${name}" th:attr="data-user-name=${name}"></span>
    </p>

    <!-- ê³„ì¢Œ ì¡°íšŒ ë²„íŠ¼ -->
    <button id="fetch-account-btn">ê³„ì¢Œ ì¡°íšŒ</button>
    <button id="create-account-btn" style="display: none;" onclick="createAccount()">ê³„ì¢Œ ìƒì„±</button>

    <!-- ê³„ì¢Œ ì •ë³´ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="account-info" style="display: none;">
<!--        <p><strong>ì‚¬ìš©ì ID:</strong> <span id="account-username"></span></p>-->
        <p><strong>ê³„ì¢Œ ì”ì•¡:</strong> <span id="account-balance"></span> ì›</p>
<!--        <p><strong>í€ë”© ì°¨ë‹¨ ì—¬ë¶€:</strong> <span id="funding-status"></span></p>-->
    </div>

    <!-- ê³„ì¢Œ ê´€ë ¨ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="account-actions" style="display: none; margin-top: 20px;">
        <button id="chargeBtn">ì¶©ì „í•˜ê¸°</button>
        <button id="payBtn">ê²°ì œí•˜ê¸°</button>
        <button id="refundBtn">í™˜ë¶ˆí•˜ê¸°</button>
    </div>
</div>

<script>
    document.getElementById("fetch-account-btn").addEventListener("click", async function () {

     const userNameElement = document.getElementById("username");
     const userName = userNameElement ? userNameElement.getAttribute("data-user-name") : "unknown";

     console.log("ğŸ” JavaScriptì—ì„œ userName ê°’:", userName);

     if (!userName || userName === "unknown") {
         alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
         return;
     }

     const apiUrl = `/api/account/user/${userName}`;
     console.log(`ğŸ“Œ ìš”ì²­ URL: ${apiUrl}`);

     const accessToken = localStorage.getItem("accessToken");
     console.log("ğŸ” JWT í† í°:", accessToken);

     if (!accessToken) {
         alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
         return;
     }

     try {
         const response = await fetch(apiUrl, {
             method: "GET",
             headers: {
                 "Authorization": `Bearer ${accessToken}`,
                 "Content-Type": "application/json"
             }
         });

         console.log("ğŸ“Œ API ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);

         if (!response.ok) {
             console.error(`âŒ ê³„ì¢Œ ì •ë³´ ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
             alert("ê³„ì¢Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
             return;
         }

         const data = await response.json();
         console.log("âœ… ê³„ì¢Œ ì •ë³´:", data);

         if (!data.accountExists) {
             document.getElementById("create-account-btn").style.display = "block";
             alert("ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•˜ì„¸ìš”.");
         } else {
             document.getElementById("account-info").style.display = "block";
             <!--document.getElementById("account-username").innerText = data.username;-->
             document.getElementById("account-balance").innerText = data.balance;
             <!--document.getElementById("funding-status").innerText = data.fundingBlocked ? "ì°¨ë‹¨ë¨" : "í™œì„±í™”ë¨";-->
             <!--document.getElementById("funding-status").style.color = data.fundingBlocked ? "red" : "green";-->
             document.getElementById("account-actions").style.display = "block";
         }
     } catch (error) {
         console.error("âŒ API í˜¸ì¶œ ì˜¤ë¥˜:", error);
         alert("ê³„ì¢Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
     }
 });

     async function createAccount() {
         console.log("ğŸ” ê³„ì¢Œ ìƒì„± ìš”ì²­!");

         const accessToken = localStorage.getItem("accessToken");
         const userNameElement = document.getElementById("username");
         const userName = userNameElement ? userNameElement.getAttribute("data-user-name") : "unknown";

         if (!accessToken) {
             alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
             return;
         }

         try {
             const response = await fetch(`/api/account/user/${userName}/create`, {

                 method: "POST",
                 headers: {
                     "Authorization": `Bearer ${accessToken}`,
                     "Content-Type": "application/json"
                 }
             });

             const newAccount = await response.json();

             if (response.ok) {
                 alert("ê³„ì¢Œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                 location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê³„ì¢Œ ì •ë³´ ë°˜ì˜
             } else {
                 alert("ê³„ì¢Œ ìƒì„± ì‹¤íŒ¨: " + newAccount.message);
             }
         } catch (error) {
             console.error("âŒ ê³„ì¢Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
             alert("ê³„ì¢Œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
         }
     }

     document.getElementById("chargeBtn").addEventListener("click", async function () {
         let amountInput = prompt("ì¶©ì „ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”");
         if (!amountInput) {
             return; // ì…ë ¥ ì·¨ì†Œí•œ ê²½ìš°
         }

         // ì…ë ¥ë°›ì€ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜ í›„ ìœ íš¨ì„± ì²´í¬
         const amount = parseInt(amountInput, 10);
         if (isNaN(amount) || amount < 1000) {
             alert("ìµœì†Œ 10,00ì› ì´ìƒì˜ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
             return;
         }

         const accessToken = localStorage.getItem("accessToken");
         if (!accessToken) {
             alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
             return;
         }

         const apiUrl = `/api/account`;
         console.log(`ì¶©ì „ ì‹œì‘: ${apiUrl}`);

         try {
             const response = await fetch(apiUrl, {
                 method: "POST",
                 headers: {
                     "Authorization": `Bearer ${accessToken}`,
                     "Content-Type": "application/json"
                 },
                 body: JSON.stringify({ amount })
             });

             const result = await response.json();

             if (response.ok) {
                 alert("ê³„ì¢Œ ì¶©ì „ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
                 location.reload();
             } else {
                 alert("ê³„ì¢Œ ì¶©ì „ ì‹¤íŒ¨: " + result.message);
             }
         } catch (error) {
             console.error("ì¶©ì „ API í˜¸ì¶œ ì˜¤ë¥˜:", error);
             alert("ê³„ì¢Œ ì¶©ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
         }




     });

</script>

</body>
</html>
