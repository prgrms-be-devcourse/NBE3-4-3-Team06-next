<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/css/profile.css">
</head>
<body>
<div class="modify-container">
    <h2>í”„ë¡œí•„ ìˆ˜ì •</h2>
    <p><strong>ì‚¬ìš©ì ID:</strong> <span id="userName"></span></p>
    <p><strong>ì´ë©”ì¼:</strong> <input type="email" class="form-control" id="editUserEmail" required></p>
    <p><strong>ì—­í• :</strong> <span id="userRole"></span></p>
    <p><strong>ê°€ì…ì¼:</strong> <span id="userCreatedAt"></span></p>
    <p><strong>ìµœê·¼ ìˆ˜ì •ì¼:</strong> <span id="userUpdatedAt"></span></p>

    <form id="modifyForm">
        <button type="submit" class="btn btn-success">ì €ì¥</button>
        <button type="button" onclick="window.close();" class="btn btn-secondary">ë‹«ê¸°</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const username = decodeURIComponent(window.location.pathname.split("/").slice(-1)[0]);
        const token = localStorage.getItem("accessToken");

        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.close();
            return;
        }
tus

        try {
            console.log(`ğŸ“Œ ì‚¬ìš©ì ì •ë³´ ìš”ì²­: /api/users/profile/${username}`);

            const response = await fetch(`/api/users/profile/${username}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŒ");
            }

            const data = await response.json();
            console.log("ğŸ“Œ ë°›ì€ ì‚¬ìš©ì ë°ì´í„°:", data);

            document.getElementById("userName").textContent = data.data.name;
            document.getElementById("editUserEmail").value = data.data.email;
            document.getElementById("userRole").textContent = data.data.role;
            document.getElementById("userCreatedAt").textContent = new Date(data.data.createdAt).toISOString().split("T")[0];
            document.getElementById("userUpdatedAt").textContent = new Date(data.data.updatedAt).toISOString().split("T")[0];

        } catch (error) {
            console.error("ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            window.close();
        }
    });

    document.getElementById("modifyForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const username = decodeURIComponent(window.location.pathname.split("/").slice(-1)[0]);
        const updatedEmail = document.getElementById("editUserEmail").value;
        const token = localStorage.getItem("accessToken");

        if (!updatedEmail.trim()) {
            alert("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            console.log("ì—…ë°ì´íŠ¸ ìš”ì²­ ë°ì´í„°:", JSON.stringify({ newEmail: updatedEmail })); // ë””ë²„ê¹…ìš© ë¡œê·¸

            const response = await fetch(`/api/users/profile/modify/${username}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ newEmail: updatedEmail })  // JSON í•„ë“œëª… ìˆ˜ì •
            });

            if (!response.ok) {
                let errorMessage = "ì´ë©”ì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨";
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch (jsonError) {
                    console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
                throw new Error(errorMessage);
            }

            let successMessage = "ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
            try {
                const responseData = await response.json();
                successMessage = responseData.message || successMessage;
            } catch (jsonError) {
                console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤. ì„±ê³µ ë©”ì‹œì§€ ê¸°ë³¸ê°’ ì‚¬ìš©.");
            }

            alert(successMessage);
            window.opener.location.reload();  // ë¶€ëª¨ì°½ ìƒˆë¡œê³ ì¹¨
            window.close();
        } catch (error) {
            console.error("ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            alert(`ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    });
</script>
</body>
</html>
